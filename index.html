<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POM CPU PRO v11.2</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* --- GLOBAL --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; background: #121212; color: white; }

        /* HEADER */
        .status-bar {
            position: absolute; top: 0; left: 0; right: 0; height: 50px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        .conn-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; box-shadow: 0 0 10px #10b981; }
        .conn-dot.offline { background: #ef4444; box-shadow: none; }
        
        .btn-switch {
            background: rgba(255,255,255,0.15); backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2); color: white;
            padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: bold;
            display: flex; align-items: center; gap: 5px; cursor: pointer;
        }

        /* --- VIEW 1: MESIN (DEFAULT) --- */
        #viewMesin { height: 100%; display: flex; flex-direction: column; }
        
        .lcd-area {
            background: #000; padding: 60px 20px 20px;
            border-bottom: 4px solid #dc2626;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .lcd-panel {
            background: #263238; border: 6px solid #37474f; border-radius: 10px; padding: 15px;
            font-family: 'Share Tech Mono', monospace; display: flex; flex-direction: column; gap: 5px;
        }
        .lcd-row { display: flex; justify-content: space-between; align-items: baseline; border-bottom: 1px dashed rgba(76, 175, 80, 0.3); }
        
        /* Warna LCD Normal (Hijau) */
        .lcd-lbl { font-size: 14px; color: #4caf50; opacity: 0.8; }
        .lcd-val { font-size: 36px; color: #4caf50; text-shadow: 0 0 10px rgba(76, 175, 80, 0.4); }
        .lcd-val.sm { font-size: 24px; }

        /* Warna LCD Mode Menu (Kuning) */
        .menu-mode .lcd-lbl { color: #f59e0b; }
        .menu-mode .lcd-val { color: #f59e0b; text-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }

        .keypad-area { flex: 1; background: #1e1e1e; padding: 20px; display: flex; flex-direction: column; justify-content: center; }
        .info-bar { text-align: center; font-size: 10px; color: #555; margin-bottom: 15px; font-family: 'Share Tech Mono'; }
        
        .keys-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; height: 100%; max-height: 400px; }
        .key {
            background: #333; border: none; border-radius: 10px; color: white;
            font-family: 'Inter', sans-serif; font-size: 24px; font-weight: 800;
            box-shadow: 0 5px 0 #111; cursor: pointer; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .key:active { transform: translateY(5px); box-shadow: none; }
        .key.c { background: #f59e0b; color: black; }
        .key.ent { background: #dc2626; grid-row: span 2; font-size: 18px; }
        .key.p { font-size: 14px; background: #424242; }

        /* --- VIEW 2: ADMIN (HIDDEN) --- */
        #viewAdmin { display: none; height: 100%; background: #F2F4F7; color: #1e293b; overflow-y: auto; position: relative; }
        
        .adm-head { background: white; padding: 70px 20px 20px; border-bottom: 1px solid #eee; }
        .adm-title { font-size: 24px; font-weight: 900; color: #1e293b; }
        
        .card { background: white; padding: 20px; border-radius: 20px; margin: 15px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .card-val { font-size: 32px; font-weight: 800; color: #7F3DFF; margin: 5px 0; }
        .card-lbl { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 20px; }
        .box { background: white; padding: 15px; border-radius: 15px; }
        
        .history-list { padding: 20px; padding-bottom: 50px; }
        .h-item { display: flex; justify-content: space-between; padding: 15px; background: white; border-radius: 12px; margin-bottom: 8px; border: 1px solid #eee; }

    </style>
</head>
<body>

    <div class="status-bar">
        <div class="conn-dot" id="connDot"></div>
        <div class="btn-switch" onclick="switchMode()">
            <span class="material-icons-round" style="font-size:16px;">admin_panel_settings</span>
            <span id="btnText">ADMIN</span>
        </div>
    </div>

    <div id="viewMesin">
        <div class="lcd-area">
            <div class="lcd-panel" id="lcdPanel">
                <div class="lcd-row">
                    <span class="lcd-lbl" id="lbl1">HARGA</span>
                    <span class="lcd-val sm" id="val1">10000</span>
                </div>
                <div class="lcd-row">
                    <span class="lcd-lbl" id="lbl2">LITER</span>
                    <span class="lcd-val" id="val2">0.00</span>
                </div>
                <div class="lcd-row" style="border:none; margin-top:10px;">
                    <span class="lcd-lbl" id="lbl3">RUPIAH</span>
                    <span class="lcd-val" style="font-size:48px;" id="val3">0</span>
                </div>
            </div>
        </div>

        <div class="keypad-area">
            <div class="info-bar">
                MENU: <strong>1013</strong> (Kalibrasi) • <strong>1015</strong> (Harga) • <strong>1379</strong> (Stok)
            </div>
            <div class="keys-grid">
                <button class="key" onclick="press('1')">1</button>
                <button class="key" onclick="press('2')">2</button>
                <button class="key" onclick="press('3')">3</button>
                <button class="key c" onclick="press('C')">C</button>

                <button class="key" onclick="press('4')">4</button>
                <button class="key" onclick="press('5')">5</button>
                <button class="key" onclick="press('6')">6</button>
                <button class="key p" onclick="preset(10000)">P1</button>

                <button class="key" onclick="press('7')">7</button>
                <button class="key" onclick="press('8')">8</button>
                <button class="key" onclick="press('9')">9</button>
                <button class="key p" onclick="preset(20000)">P2</button>

                <button class="key" style="font-size:14px;" onclick="press('.')">.</button>
                <button class="key" onclick="press('0')">0</button>
                <button class="key" style="font-size:14px;" onclick="press('00')">00</button>
                <button class="key ent" onclick="process()">ENT</button>
            </div>
        </div>
    </div>

    <div id="viewAdmin">
        <div class="adm-head">
            <div style="font-size:12px; color:#64748b; font-weight:600;">DASHBOARD</div>
            <div class="adm-title">Laporan Keuangan</div>
        </div>

        <div class="card">
            <div class="card-lbl">PROFIT BERSIH (HARI INI)</div>
            <div class="card-val" id="admProfit">Rp 0</div>
            <div style="font-size:11px; margin-top:5px; color:#10b981;" id="admMargin">Margin: Rp 0 / Liter</div>
        </div>

        <div class="grid-2">
            <div class="box">
                <div class="card-lbl">UANG MASUK</div>
                <div style="font-size:18px; font-weight:800; margin-top:5px;" id="admOmset">Rp 0</div>
            </div>
            <div class="box" style="background:#e0f2fe;">
                <div class="card-lbl" style="color:#0369a1;">SISA STOK</div>
                <div style="font-size:18px; font-weight:800; color:#0284c7; margin-top:5px;" id="admStok">0 L</div>
            </div>
        </div>

        <div class="history-list">
            <h4 style="margin:20px 0 10px; color:#333;">Riwayat Transaksi</h4>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // --- DEFINISI VARIABEL DI AWAL (PENTING AGAR TIDAK ERROR) ---
        let screenInput = "";
        let activeMenu = null; // null = standby, 'stock', 'price', 'pulse', 'modal'
        let db = {
            price: 10000,
            modal: 9000,
            stock: 0,
            pulse: 360,
            trans: []
        };

        // --- FIREBASE SETUP ---
        const firebaseConfig = { 
            apiKey: "AIzaSyBpwNPIYhelOhkPvJsBmKvlZnaH9FVnmM4", 
            authDomain: "pom-mini-50b1e.firebaseapp.com", 
            projectId: "pom-mini-50b1e", 
            storageBucket: "pom-mini-50b1e.firebasestorage.app", 
            messagingSenderId: "77499696502", 
            appId: "1:77499696502:web:8080c37da62a12c9566657", 
            measurementId: "G-KRRHTTGBRF" 
        };
        
        let dbFirestore;
        try {
            firebase.initializeApp(firebaseConfig);
            dbFirestore = firebase.firestore();
            dbFirestore.settings({ experimentalForceLongPolling: true, merge: true });
        } catch(e) { console.log("Offline"); document.getElementById('connDot').classList.add('offline'); }

        // --- SYSTEM INIT ---
        function init() {
            let saved = localStorage.getItem('dl_v11_pro');
            if(saved) db = { ...db, ...JSON.parse(saved) };
            updateDisplay();

            if(dbFirestore) {
                const docRef = dbFirestore.collection("data_toko").doc("config_v11");
                docRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        db = { ...db, ...doc.data() };
                        localStorage.setItem('dl_v11_pro', JSON.stringify(db)); 
                        updateDisplay();
                        if(document.getElementById('viewAdmin').style.display === 'block') renderAdmin();
                    }
                });
            }
        }
        
        // --- NAVIGATION ---
        function switchMode() {
            let mesin = document.getElementById('viewMesin');
            let admin = document.getElementById('viewAdmin');
            let btn = document.getElementById('btnText');

            if(mesin.style.display !== 'none') {
                mesin.style.display = 'none';
                admin.style.display = 'block';
                btn.innerText = "MESIN";
                renderAdmin();
            } else {
                mesin.style.display = 'flex';
                admin.style.display = 'none';
                btn.innerText = "ADMIN";
                updateDisplay();
            }
        }

        // --- MESIN LOGIC (CORE) ---
        function press(key) {
            // Jika pencet C, reset input
            if(key === 'C') {
                if(activeMenu) closeMenu(); // Keluar menu
                else { screenInput = ""; updateDisplay(); } // Reset layar biasa
                return;
            }

            // Batasi panjang input
            if(screenInput.length < 8) {
                if(activeMenu && (key === '.' || key === '00')) return; // Menu cuma terima angka bulat
                screenInput += key;
                
                // Update tampilan angka
                if(activeMenu) {
                    document.getElementById('val3').innerText = screenInput;
                } else {
                    document.getElementById('val3').innerText = screenInput;
                }
            }
        }

        function preset(val) {
            if(!activeMenu) {
                screenInput = val.toString();
                document.getElementById('val3').innerText = screenInput;
            }
        }

        function process() {
            // 1. JIKA SEDANG DI MENU (Simpan Setting)
            if(activeMenu) {
                let val = parseFloat(screenInput);
                if(isNaN(val)) return;
                
                if(activeMenu === 'pulse') db.pulse = val;
                else if(activeMenu === 'price') db.price = val;
                else if(activeMenu === 'modal') db.modal = val;
                else if(activeMenu === 'stock') db.stock = val;

                save(); 
                alert("TERSIMPAN: " + val);
                closeMenu(); 
                return;
            }

            // 2. DETEKSI KODE RAHASIA
            if(screenInput === "1013") { openMenu('pulse', "SET PULSE"); return; }
            if(screenInput === "1015") { openMenu('price', "SET HARGA JUAL"); return; }
            if(screenInput === "1000") { openMenu('modal', "SET HARGA KULAKAN"); return; }
            if(screenInput === "1379") { openMenu('stock', "ISI STOK (LITER)"); return; }

            // 3. PROSES JUALAN
            let nom = parseInt(screenInput);
            if(!nom) return;

            let literLayar = nom / db.price;
            let literFisik = literLayar * (db.pulse / 400); // Rumus Inti 360

            if(db.stock < literFisik) {
                alert("STOK HABIS! Sisa: " + db.stock.toFixed(2) + " L\nSilakan Kode 1379 untuk isi.");
                screenInput = ""; updateDisplay(); return;
            }

            // Eksekusi
            db.stock -= literFisik;
            
            let now = new Date();
            db.trans.unshift({
                date: now.toLocaleDateString(),
                time: now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}),
                nominal: nom,
                l_layar: literLayar,
                l_fisik: literFisik
            });
            if(db.trans.length > 50) db.trans.pop();

            save();
            
            // Animasi Loading
            screenInput = "";
            document.getElementById('val3').innerText = "PROSES...";
            setTimeout(() => {
                document.getElementById('val3').innerText = nom;
                document.getElementById('val2').innerText = literLayar.toFixed(2);
            }, 500);
        }

        // --- MENU SYSTEM (LCD OVERRIDE) ---
        function openMenu(type, title) {
            activeMenu = type;
            screenInput = "";
            
            // Ubah Tampilan LCD jadi Mode Menu (Kuning)
            document.getElementById('lcdPanel').classList.add('menu-mode');
            
            document.getElementById('lbl1').innerText = "MODE MENU";
            document.getElementById('val1').innerText = "--------";
            
            document.getElementById('lbl2').innerText = title;
            document.getElementById('val2').innerText = "INPUT:";
            
            document.getElementById('lbl3').innerText = "NILAI BARU";
            document.getElementById('val3').innerText = "_";
        }

        function closeMenu() {
            activeMenu = null;
            screenInput = "";
            document.getElementById('lcdPanel').classList.remove('menu-mode');
            updateDisplay();
        }

        function updateDisplay() {
            // Kembalikan teks LCD ke normal
            document.getElementById('lbl1').innerText = "HARGA";
            document.getElementById('val1').innerText = db.price;
            
            document.getElementById('lbl2').innerText = "LITER";
            
            document.getElementById('lbl3').innerText = "RUPIAH";
            
            if(!screenInput) {
                document.getElementById('val2').innerText = "0.00";
                document.getElementById('val3').innerText = "0";
            }
        }

        // --- ADMIN RENDER ---
        function renderAdmin() {
            let today = new Date().toLocaleDateString();
            let dInc = 0, dLitFisik = 0;

            db.trans.forEach(t => {
                if(t.date === today) {
                    dInc += t.nominal;
                    dLitFisik += t.l_fisik;
                }
            });

            let hpp = dLitFisik * db.modal;
            let profit = dInc - hpp;
            let margin = db.price - db.modal;
            const fmt = (n) => "Rp " + parseInt(n).toLocaleString('id-ID');

            document.getElementById('admProfit').innerText = fmt(profit);
            document.getElementById('admMargin').innerText = `Margin: ${fmt(margin)}/L (Modal ${fmt(db.modal)})`;
            document.getElementById('admOmset').innerText = fmt(dInc);
            document.getElementById('admStok').innerText = db.stock.toFixed(2) + " L";

            document.getElementById('historyList').innerHTML = db.trans.slice(0,10).map(t => `
                <div class="h-item">
                    <div>
                        <strong style="font-size:14px;">${t.time}</strong><br>
                        <span style="color:#64748b">Layar: ${t.l_layar.toFixed(2)}L</span>
                    </div>
                    <div style="text-align:right;">
                        <strong style="color:#10b981; font-size:14px;">+${fmt(t.nominal)}</strong><br>
                        <span style="color:#dc2626; font-size:10px;">Fisik: ${t.l_fisik.toFixed(3)}L</span>
                    </div>
                </div>
            `).join('');
        }

        // --- SAVE DATA ---
        function save() {
            localStorage.setItem('dl_v11_pro', JSON.stringify(db));
            if(dbFirestore) {
                dbFirestore.collection("data_toko").doc("config_v11").set(db).catch(console.error);
            }
        }

        // Jalankan Init Terakhir
        init();

    </script>
</body>
</html>